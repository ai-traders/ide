#!/bin/bash


helpfunc() {
    echo "Usage: $0 [--group GROUP] [--idefile IDEFILE] COMMAND"
    echo "  --help     Help. Display this message and quit."
    echo "  --version  Version. Print version number and quit."
    echo "  --group    Specify GROUP from Idefile"
    echo "  --idefile  Specify IDEFILE, default is: ./Idefile"
    exit
}

log_debug() {
    if [ "$IDE_LOG" == "debug" ]; then
      echo "$1"
    fi
}

groupname="default"
idefile="${PWD}/Idefile"
version="0.0.1"
dryrun="false"
while (( $# > 0 ))
do
    opt="$1"
    shift

    case $opt in
    --help)
        helpfunc
        exit 0
        ;;
    --version)
        echo "$0 version $version"
        exit 0
        ;;
    --group)  # Example with an operand
        echo "groupnames other than default are not supported"
        exit 1;
        # TODO: support groups
        # groupname="$1"
        # shift
        ;;
    --idefile)  # Example with an operand
        idefile="$1"
        shift
        ;;
    --dryrun)
        dryrun="true"
        ;;
    --*)
        echo "Invalid option: '$opt'" >&2
        exit 1
        ;;
    -*)
        echo "Invalid option: '$opt'" >&2
        exit 1
        ;;
    *)
        # end of long options
        break;
        ;;
   esac

done

# verify options
if [ -z "$groupname" ]; then
  echo "groupname not specified"
  exit 1;
fi
if [ -z "$idefile" ]; then
  echo "idefile not specified"
  exit 1;
fi
if [ ! -f "$idefile" ]; then
  echo "idefile: $idefile does not exist"
  exit 1;
fi
log_debug "Starting ide, version: $version"
log_debug "groupname: $groupname"
log_debug "idefile: $idefile"

if [[ "$dryrun" == "true" ]]; then
  exit 0
fi

# verify Idefile
source $idefile
if [ -z "$IDE_DOCKER_IMAGE" ]; then
  echo "IDE_DOCKER_IMAGE not set"
  exit 1;
fi
if [ -z "$IDE_DOCKER_DRIVER" ]; then
  IDE_DOCKER_DRIVER="docker"
  log_debug "IDE_DOCKER_DRIVER not set, setting to: $IDE_DOCKER_DRIVER"
fi
if [ "$IDE_DOCKER_DRIVER" != "docker" ]; then
  echo "IDE_DOCKER_DRIVER set to $IDE_DOCKER_DRIVER, supported is only: docker"
  exit 1
fi
if [ -z "$IDE_WORK" ]; then
  IDE_WORK=$PWD
  log_debug "IDE_WORK not set, setting to: $IDE_WORK"
fi
if [ ! -d "$IDE_WORK" ]; then
  echo "IDE_WORK set to $IDE_WORK which does not exist"
  exit 1
fi
if [ -z "$IDE_HOME" ]; then
  IDE_HOME=$HOME
  log_debug "IDE_HOME not set, setting to: $IDE_HOME"
fi
if [ ! -d "$IDE_HOME" ]; then
  echo "IDE_HOME set to $IDE_HOME which does not exist"
  exit 1
fi

# pull docker image, exit on error
docker pull $IDE_DOCKER_IMAGE
exit_status="$?"
if [[ "$exit_status" != "0" ]]; then
  exit $exit_status
fi

# construct docker command
echo $IDE_DOCKER_IMAGE
echo $IDE_DOCKER_DRIVER
